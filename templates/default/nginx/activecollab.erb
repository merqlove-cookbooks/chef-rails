set $root_path <%= @path %>/docs/<%= @path_suffix || '' %>;

index index.html index.htm index.php router.php;

if (!-e $request_filename) {
  rewrite ^/assets/(.*)$ /assets/$1 last;
  rewrite ^/avatars/(.*)$ /avatars/$1 last;
  rewrite ^/wallpapers/(.*)$ /wallpapers/$1 last;
  rewrite ^/verify-existence$ /verify.php last;
  rewrite ^/proxy.php$ /proxy.php last;
  rewrite ^/api/v([0-9]*)/(.*)$ /api.php?path_info=$2&api_version=$1 last;
  rewrite ^$ /router.php last;
  rewrite ^(.*) /router.php?path_info=$1 last;
}

location / {
  rewrite ^/verify-existence$ /verify.php last;
  rewrite ^/proxy.php$ /proxy.php last;
  rewrite ^/api/v([0-9]*)/(.*)$ /api.php?path_info=$2&api_version=$1 last;
  rewrite ^/$ /router.php last;

  try_files $uri $uri/ /router.php?path_info=$uri&$args;
}

location ~ ^/(assets|avatars|wallpapers)/ {
  root $root_path;
}

location @engine_file_rewrite {
}

location @php_fallback {
  try_files $uri /router.php?path_info=$uri&$args;
}
